@page "/"
@using Tracker.Client.Services
@using Tracker.Client.Dtos
@inject GitHubApiService GitHubService
@inject NavigationManager NavigationManager

<PageTitle>GitHub Dashboard</PageTitle>

<div class="dashboard">
     @if (loading)
    {
        <div class="loading-spinner">
            <p>Loading ProjectV2 data...</p>
        </div>
    }
    else if (error != null)
    {
        <p class="text-danger">@error</p>
    }
    else
    {
        @if (project != null)
        {
            <!-- GitHub Insights Section -->
            <section class="insights-section">
                <div class="insights-header">
                    <h2>GitHub Insights</h2>
                    <div class="insights-meta">
                        Last refresh: @DateTime.Now.ToString("hh:mm tt") | @selectedOrg - Project #@projectNumber
                    </div>
                </div>

                <div class="insights-grid">
                    <div class="insight-card">
                        <div class="insight-label">Total Items</div>
                        <div class="insight-value">@GetTotalItems()</div>
                    </div>

                    @foreach (var status in GetAllStatuses())
                    {
                        <div class="insight-card">
                            <div class="insight-label">@status</div>
                            <div class="insight-value">@GetItemsByStatus(status)</div>
                        </div>
                    }

                    <div class="insight-card">
                        <div class="insight-label">No Status</div>
                        <div class="insight-value">@GetItemsWithoutStatus()</div>
                    </div>

                    <div class="insight-card">
                        <div class="insight-label">Open PRs</div>
                        <div class="insight-value">@GetOpenPullRequests()</div>
                    </div>

                    <div class="insight-card">
                        <div class="insight-label">Merged PRs</div>
                        <div class="insight-value">@GetMergedPullRequests()</div>
                    </div>
                    <div class="insight-card">
                        <div class="insight-label"> Open Issues</div>
                        <div class="insight-value">@GetIssues()</div>
                    </div>
                </div>
            </section>

            <!-- Developer Timeline Section -->
            <section class="timeline-section">
                <div class="timeline-header">
                    <h2>Developer Timeline</h2>
                    <div class="timeline-date">@DateTime.Now.ToString("MMMM dd, yyyy")</div>
                </div>

                <div class="timeline-columns">
                    <!-- Backlog Column -->
                    <div class="timeline-column">
                        <div class="column-header">
                            <span class="status-badge ready">Backlog</span>
                            <span class="column-count">@GetItemsByStatus("Backlog")</span>
                        </div>
                        <ul class="task-list">
                            @foreach (var item in GetItemsForColumn("Backlog"))
                            {
                                <li class="task-item @GetOverdueClass(item)" @onclick="() => OpenItemUrl(item)">
                                    <div class="task-title">
                                        <span class="task-type-badge @GetItemTypeBadgeClass(item.type)">
                                            @GetItemTypeLabel(item.type)
                                        </span>
                                        @item.content?.title
                                    </div>
                                    <div class="task-meta">
                                        <div class="assignee-list">
                                            @if (GetAssignees(item).Any())
                                            {
                                                @foreach (var assignee in GetAssignees(item))
                                                {
                                                    <img src="@assignee.avatarUrl"
                                                         alt="@assignee.login"
                                                         title="@(assignee.name ?? assignee.login)"
                                                         class="assignee-avatar" />
                                                }
                                            }
                                            else
                                            {
                                                <span class="task-assignee">Unassigned</span>
                                            }
                                        </div>
                                        <div style="display: flex; gap: 8px; align-items: center;">
                                            @if (GetOverdueInfo(item).IsOverdue || GetOverdueInfo(item).IsDueSoon)
                                            {
                                                <span class="overdue-badge @(GetOverdueInfo(item).IsOverdue ? "overdue" : "due-soon")">
                                                    @GetOverdueInfo(item).Message
                                                </span>
                                            }
                                            @if (item.content?.number != null)
                                            {
                                                <span>#@item.content.number</span>
                                            }
                                        </div>
                                    </div>
                                </li>
                            }
                        </ul>
                    </div>

                    <!-- In Progress Column -->
                    <div class="timeline-column">
                        <div class="column-header">
                            <span class="status-badge in-progress">In Progress</span>
                            <span class="column-count">@GetItemsByStatus("In progress")</span>
                        </div>
                        <ul class="task-list">
                            @foreach (var item in GetItemsForColumn("In progress"))
                            {
                                <li class="task-item @GetOverdueClass(item)" @onclick="() => OpenItemUrl(item)">
                                    <div class="task-title">
                                        <span class="task-type-badge @GetItemTypeBadgeClass(item.type)">
                                            @GetItemTypeLabel(item.type)
                                        </span>
                                        @item.content?.title
                                    </div>
                                    <div class="task-meta">
                                        <div class="assignee-list">
                                            @if (GetAssignees(item).Any())
                                            {
                                                @foreach (var assignee in GetAssignees(item))
                                                {
                                                    <img src="@assignee.avatarUrl"
                                                         alt="@assignee.login"
                                                         title="@(assignee.name ?? assignee.login)"
                                                         class="assignee-avatar" />
                                                }
                                            }
                                            else
                                            {
                                                <span class="task-assignee">Unassigned</span>
                                            }
                                        </div>
                                        <div style="display: flex; gap: 8px; align-items: center;">
                                            @if (GetOverdueInfo(item).IsOverdue || GetOverdueInfo(item).IsDueSoon)
                                            {
                                                <span class="overdue-badge @(GetOverdueInfo(item).IsOverdue ? "overdue" : "due-soon")">
                                                    @GetOverdueInfo(item).Message
                                                </span>
                                            }
                                            @if (item.content?.number != null)
                                            {
                                                <span>#@item.content.number</span>
                                            }
                                        </div>
                                    </div>
                                </li>
                            }
                        </ul>
                    </div>

                    <!-- In Review Column -->
                    <div class="timeline-column">
                        <div class="column-header">
                            <span class="status-badge unassigned">In Review</span>
                            <span class="column-count">@GetItemsByStatus("In review")</span>
                        </div>
                        <ul class="task-list">
                            @foreach (var item in GetItemsForColumn("In review"))
                            {
                                <li class="task-item @GetOverdueClass(item)" @onclick="() => OpenItemUrl(item)">
                                    <div class="task-title">
                                        <span class="task-type-badge @GetItemTypeBadgeClass(item.type)">
                                            @GetItemTypeLabel(item.type)
                                        </span>
                                        @item.content?.title
                                    </div>
                                    <div class="task-meta">
                                        <div class="assignee-list">
                                            @if (GetAssignees(item).Any())
                                            {
                                                @foreach (var assignee in GetAssignees(item))
                                                {
                                                    <img src="@assignee.avatarUrl"
                                                         alt="@assignee.login"
                                                         title="@(assignee.name ?? assignee.login)"
                                                         class="assignee-avatar" />
                                                }
                                            }
                                            else
                                            {
                                                <span class="task-assignee">Unassigned</span>
                                            }
                                        </div>
                                        <div style="display: flex; gap: 8px; align-items: center;">
                                            @if (GetOverdueInfo(item).IsOverdue || GetOverdueInfo(item).IsDueSoon)
                                            {
                                                <span class="overdue-badge @(GetOverdueInfo(item).IsOverdue ? "overdue" : "due-soon")">
                                                    @GetOverdueInfo(item).Message
                                                </span>
                                            }
                                            @if (item.content?.number != null)
                                            {
                                                <span>#@item.content.number</span>
                                            }
                                        </div>
                                    </div>
                                </li>
                            }
                        </ul>
                    </div>

                    <!-- Done Column -->
                    <div class="timeline-column">
                        <div class="column-header">
                            <span class="status-badge ready">Done</span>
                            <span class="column-count">@GetItemsByStatus("Done")</span>
                        </div>
                        <ul class="task-list">
                            @foreach (var item in GetItemsForColumn("Done").Take(5))
                            {
                                <li class="task-item" @onclick="() => OpenItemUrl(item)">
                                    <div class="task-title">
                                        <span class="task-type-badge @GetItemTypeBadgeClass(item.type)">
                                            @GetItemTypeLabel(item.type)
                                        </span>
                                        @item.content?.title
                                    </div>
                                    <div class="task-meta">
                                        <div class="assignee-list">
                                            @if (GetAssignees(item).Any())
                                            {
                                                @foreach (var assignee in GetAssignees(item))
                                                {
                                                    <img src="@assignee.avatarUrl"
                                                         alt="@assignee.login"
                                                         title="@(assignee.name ?? assignee.login)"
                                                         class="assignee-avatar" />
                                                }
                                            }
                                            else
                                            {
                                                <span class="task-assignee">Unassigned</span>
                                            }
                                        </div>
                                        @if (item.content?.number != null)
                                        {
                                            <span>#@item.content.number</span>
                                        }
                                    </div>
                                </li>
                            }
                        </ul>
                    </div>
                </div>
            </section>
        }
        else
        {
            <div class="empty-state">
                <p>No ProjectV2 data found for @selectedOrg.</p>
            </div>
        }

       
    }
</div>

@code {
    private bool loading = true;
    private string? error;

    // ProjectV2
    private GitHubProjectV2ResponseDto? projectResponse;
    private ProjectV2? project;
    private int projectNumber = 11; 

    // Repositories
  //  private List<RepositoryDto> repositories = new List<RepositoryDto>();
    private List<string> organizations = new();
    private string? selectedOrg = "VariosystemsWorkspace";  
    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Load Repositories
          //  repositories = await GitHubService.GetRepositoriesAsync();
            organizations = await GitHubService.GetOrganizationsAsync();

            // Use first org if not set
            if (string.IsNullOrEmpty(selectedOrg) && organizations.Any())
            {
                selectedOrg = organizations.FirstOrDefault();
            }

            // Load ProjectV2 - fetch up to 300 items (GitHub's max per request is 100, but you can adjust)
            if (!string.IsNullOrEmpty(selectedOrg))
            {
                projectResponse = await GitHubService.GetProjectV2Async(selectedOrg, projectNumber, 100);
                project = projectResponse?.data?.organization?.projectV2;
            }
        }
        catch (Exception ex)
        {
            error = $"Error loading data: {ex.Message}";
            Console.WriteLine($"Error details: {ex}");
        }
        finally
        {
            loading = false;
        }
    }

    // Helper methods for statistics
    private int GetTotalItems()
    {
        if (project?.items?.nodes == null) return 0;
        return project.items.nodes.Count;
    }

    private List<string> GetAllStatuses()
    {
        if (project?.items?.nodes == null) return new List<string>();

        return project.items.nodes
            .SelectMany(item => item.fieldValues?.nodes ?? new List<FieldValue>())
            .Where(f => f.field?.name == "Status" && !string.IsNullOrEmpty(f.name))
            .Select(f => f.name!)
            .Distinct()
            .OrderBy(s => s)
            .ToList();
    }

    private int GetItemsByStatus(string status)
    {
        if (project?.items?.nodes == null) return 0;
        return project.items.nodes.Count(item =>
            item.fieldValues?.nodes?.Any(f =>
                f.field?.name == "Status" && f.name == status) == true);
    }

    private int GetItemsWithoutStatus()
    {
        if (project?.items?.nodes == null) return 0;
        return project.items.nodes.Count(item =>
            item.fieldValues?.nodes?.Any(f => f.field?.name == "Status") != true);
    }

    private int GetOpenPullRequests()
    {
        if (project?.items?.nodes == null) return 0;
        return project.items.nodes.Count(i =>
            i.type == "PULL_REQUEST" &&
            i.content?.state?.ToLower() == "open");
    }

    private int GetMergedPullRequests()
    {
        if (project?.items?.nodes == null) return 0;
        return project.items.nodes.Count(i =>
            i.type == "PULL_REQUEST" &&
            i.content?.merged == true);
    }

    private int GetIssues()
    {
        if (project?.items?.nodes == null) return 0;
        return project.items.nodes.Count(i =>
            i.type == "ISSUE" &&
            i.content?.state?.ToLower() == "open");
    }


    // Helper methods for timeline columns
    private List<ProjectItem> GetItemsForColumn(string? status)
    {
        if (project?.items?.nodes == null) return new List<ProjectItem>();

        if (status == null)
        {
            // Unassigned items
            return project.items.nodes
                .Where(item => item.fieldValues?.nodes?.Any(f => f.field?.name == "Status") != true)
                .ToList();
        }

        return project.items.nodes
            .Where(item => item.fieldValues?.nodes?.Any(f =>
                f.field?.name == "Status" && f.name == status) == true)
            .ToList();
    }

    private string GetItemTypeBadgeClass(string type)
    {
        return type?.ToLower() switch
        {
            "issue" => "issue",
            "pull_request" => "pr",
            "draft_issue" => "draft",
            _ => "draft"
        };
    }

    private string GetItemTypeLabel(string type)
    {
        return type?.ToLower() switch
        {
            "issue" => "Issue",
            "pull_request" => "PR",
            "draft_issue" => "Draft",
            _ => "Item"
        };
    }

    private string GetAssigneeFromItem(ProjectItem item)
    {
        var assignees = GetAssignees(item);
        if (assignees.Any())
        {
            return string.Join(", ", assignees.Select(a => a.name ?? a.login));
        }
        return "Unassigned";
    }

    private List<Assignee> GetAssignees(ProjectItem item)
    {
        var assigneeList = new List<Assignee>();

        // Method 1: Get assignees from content (Issue/PR assignees from GitHub)
        if (item.content?.assignees?.nodes != null && item.content.assignees.nodes.Any())
        {
            Console.WriteLine($"Found {item.content.assignees.nodes.Count} assignees in content for: {item.content?.title}");
            assigneeList.AddRange(item.content.assignees.nodes);
        }

        // Method 2: Get assignees from ProjectV2 custom field values
        var userFields = item.fieldValues?.nodes?
            .Where(f => f.__typename == "ProjectV2ItemFieldUserValue" && f.users?.nodes != null && f.users.nodes.Any())
            .ToList();

        if (userFields != null && userFields.Any())
        {
            Console.WriteLine($"Found {userFields.Count} user fields for: {item.content?.title}");
            foreach (var userField in userFields)
            {
                Console.WriteLine($"  Field: {userField.field?.name}, Users: {userField.users?.nodes?.Count ?? 0}");
                if (userField.users?.nodes != null)
                {
                    assigneeList.AddRange(userField.users.nodes.Select(u => new Assignee
                    {
                        login = u.login,
                        name = u.name,
                        avatarUrl = u.avatarUrl
                    }));
                }
            }
        }

        // Remove duplicates by login
        var uniqueAssignees = assigneeList
            .Where(a => !string.IsNullOrEmpty(a.login))
            .GroupBy(a => a.login)
            .Select(g => g.First())
            .ToList();

        if (uniqueAssignees.Any())
        {
            Console.WriteLine($"Total unique assignees for '{item.content?.title}': {uniqueAssignees.Count}");
        }
        else
        {
            Console.WriteLine($"No assignees found for: {item.content?.title}");
        }

        return uniqueAssignees;
    }

    private (bool IsOverdue, bool IsDueSoon, string Message) GetOverdueInfo(ProjectItem item)
    {
        var endDateField = item.fieldValues?.nodes?
            .FirstOrDefault(f => f.field?.name == "End date" && !string.IsNullOrEmpty(f.date));

        if (endDateField == null || string.IsNullOrEmpty(endDateField.date))
        {
            return (false, false, "");
        }

        if (!DateTime.TryParse(endDateField.date, out var endDate))
        {
            return (false, false, "");
        }

        var today = DateTime.Today;
        var daysUntilDue = (endDate.Date - today).Days;

        if (daysUntilDue < 0)
        {
            // Overdue
            var daysOverdue = Math.Abs(daysUntilDue);
            return (true, false, $"Overdue by {daysOverdue} day{(daysOverdue != 1 ? "s" : "")}");
        }
        else if (daysUntilDue <= 2)
        {
            // Due soon (within 2 days)
            if (daysUntilDue == 0)
                return (false, true, "Due today");
            else if (daysUntilDue == 1)
                return (false, true, "Due tomorrow");
            else
                return (false, true, $"Due in {daysUntilDue} days");
        }

        return (false, false, "");
    }

    private string GetOverdueClass(ProjectItem item)
    {
        var overdueInfo = GetOverdueInfo(item);
        if (overdueInfo.IsOverdue)
            return "overdue";
        else if (overdueInfo.IsDueSoon)
            return "due-soon";
        return "";
    }

    private void OpenItemUrl(ProjectItem item)
    {
        if (!string.IsNullOrEmpty(item.content?.url))
        {
            NavigationManager.NavigateTo(item.content.url, true);
        }
    }

    // private void NavigateToRepo(RepositoryDto repo)
    // {
    //     NavigationManager.NavigateTo($"/repo/{repo.Owner.Login}/{repo.Name}");
    // }
}