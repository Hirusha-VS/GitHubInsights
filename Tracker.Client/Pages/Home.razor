@page "/"
@using Tracker.Client.Services
@using Tracker.Client.Dtos
@using Tracker.Client.Models
@using Tracker.Client.Extensions
@using Tracker.Client.Helpers
@inject GitHubApiService GitHubService
@inject TaskAnalyticsService AnalyticsService
@inject WorkloadCalculationService WorkloadService
@inject NavigationManager NavigationManager

<PageTitle>GitHub Dashboard</PageTitle>

<!-- Rest of your Home.razor code stays the same -->
<PageTitle>GitHub Dashboard</PageTitle>

<div class="dashboard">
    @if (loading)
    {
        <div class="loading-spinner">
            <p>Loading ProjectV2 data...</p>
        </div>
    }
    else if (error != null)
    {
        <p class="text-danger">@error</p>
    }
    else
    {
        @if (project != null)
        {
            <!-- GitHub Insights Section -->
            <section class="insights-section">
                <div class="insights-header">
                    <h2>GitHub Insights</h2>
                    <div class="insights-meta">
                        Last refresh: @DateTime.Now.ToString("hh:mm tt") | @selectedOrg - Project #@projectNumber
                    </div>
                </div>

                <div class="insights-grid">
                    <div class="insight-card">
                        <div class="insight-label">Total Items</div>
                        <div class="insight-value">@analytics.TotalItems</div>
                    </div>

                    @foreach (var status in TaskStatusHelper.GetAllStatuses(projectItems))
                    {
                        <div class="insight-card">
                            <div class="insight-label">@status</div>
                            <div class="insight-value">@TaskStatusHelper.GetItemsByStatus(projectItems, status)</div>
                        </div>
                    }

                    <div class="insight-card">
                        <div class="insight-label">No Status</div>
                        <div class="insight-value">@TaskStatusHelper.GetItemsWithoutStatus(projectItems)</div>
                    </div>

                    <div class="insight-card">
                        <div class="insight-label">Open PRs</div>
                        <div class="insight-value">@TaskStatusHelper.GetOpenPullRequests(projectItems)</div>
                    </div>

                    <div class="insight-card">
                        <div class="insight-label">Merged PRs</div>
                        <div class="insight-value">@TaskStatusHelper.GetMergedPullRequests(projectItems)</div>
                    </div>
                    <div class="insight-card">
                        <div class="insight-label">Open Issues</div>
                        <div class="insight-value">@TaskStatusHelper.GetOpenIssues(projectItems)</div>
                    </div>
                </div>
            </section>

            <!-- Today's Tasks Overview Section -->
            <section class="today-tasks-section">
                <div class="section-header">
                    <h2>📅 Today's Task Overview</h2>
                    <div class="today-date">@DateTime.Now.ToString("dddd, MMMM dd, yyyy")</div>
                </div>

                <div class="today-summary-grid">
                    <div class="today-card due-today">
                        <div class="today-icon">⏰</div>
                        <div class="today-info">
                            <div class="today-label">Due Today</div>
                            <div class="today-value">@analytics.DueToday</div>
                        </div>
                    </div>

                    <div class="today-card overdue">
                        <div class="today-icon">🚨</div>
                        <div class="today-info">
                            <div class="today-label">Overdue</div>
                            <div class="today-value">@analytics.Overdue</div>
                        </div>
                    </div>

                    <div class="today-card in-progress">
                        <div class="today-icon">⚡</div>
                        <div class="today-info">
                            <div class="today-label">In Progress</div>
                            <div class="today-value">@analytics.InProgress</div>
                        </div>
                    </div>

                    <div class="today-card completed">
                        <div class="today-icon">✅</div>
                        <div class="today-info">
                            <div class="today-label">Done</div>
                            <div class="today-value">@analytics.Done</div>
                        </div>
                    </div>
                </div>

                @if (analytics.TasksDueToday.Any() || analytics.OverdueTasks.Any())
                {
                    <div class="urgent-tasks-list">
                        <h3>Urgent Tasks Requiring Attention</h3>
                        <div class="urgent-tasks-grid">
                            @foreach (var item in analytics.OverdueTasks.Concat(analytics.TasksDueToday).Take(6))
                            {
                                <div class="urgent-task-card" @onclick="() => OpenItemUrl(item)">
                                    <div class="urgent-task-header">
                                        <span class="task-type-badge @item.GetItemTypeBadgeClass()">
                                            @item.GetItemTypeLabel()
                                        </span>
                                        <span class="urgent-badge @(DateHelper.GetOverdueInfo(item).IsOverdue ? "overdue" : "due-today")">
                                            @DateHelper.GetOverdueInfo(item).Message
                                        </span>
                                    </div>
                                    <div class="urgent-task-title">@item.content?.title</div>
                                    <div class="urgent-task-footer">
                                        <div class="assignee-list">
                                            @if (item.GetAllAssignees().Any())
                                            {
                                                @foreach (var assignee in item.GetAllAssignees().Take(3))
                                                {
                                                    <img src="@assignee.avatarUrl"
                                                         alt="@assignee.login"
                                                         title="@(assignee.name ?? assignee.login)"
                                                         class="assignee-avatar-small" />
                                                }
                                                @if (item.GetAllAssignees().Count > 3)
                                                {
                                                    <span class="more-assignees">+@(item.GetAllAssignees().Count - 3)</span>
                                                }
                                            }
                                            else
                                            {
                                                <span class="unassigned-label">Unassigned</span>
                                            }
                                        </div>
                                        <span class="item-number">#@item.content?.number</span>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                }
            </section>

            <!-- Developer Workload Section -->
            <section class="workload-section">
                <div class="section-header">
                    <h2>👥 Developer Workload</h2>
                    <div class="workload-subtitle">Task distribution and completion status per developer</div>
                </div>

                <div class="workload-grid">
                    @foreach (var dev in workloads.OrderByDescending(d => d.TotalTasks))
                    {
                        <div class="workload-card">
                            <div class="developer-header">
                                <img src="@dev.AvatarUrl" alt="@dev.Name" class="developer-avatar" />
                                <div class="developer-info">
                                    <div class="developer-name">@dev.Name</div>
                                    <div class="developer-login">@@@dev.Login</div>
                                </div>
                            </div>

                            <div class="workload-stats">
                                <div class="stat-row">
                                    <span class="stat-label">Total Tasks</span>
                                    <span class="stat-value">@dev.TotalTasks</span>
                                </div>
                                <div class="stat-row">
                                    <span class="stat-label">Done</span>
                                    <span class="stat-value done">@dev.DoneTasks</span>
                                </div>
                                <div class="stat-row">
                                    <span class="stat-label">In Progress</span>
                                    <span class="stat-value in-progress">@dev.InProgressTasks</span>
                                </div>
                                <div class="stat-row">
                                    <span class="stat-label">In Review</span>
                                    <span class="stat-value in-review">@dev.InReviewTasks</span>
                                </div>
                                <div class="stat-row">
                                    <span class="stat-label">Backlog</span>
                                    <span class="stat-value backlog">@dev.BacklogTasks</span>
                                </div>
                                @if (dev.OverdueTasks > 0)
                                {
                                    <div class="stat-row highlight">
                                        <span class="stat-label">⚠️ Overdue</span>
                                        <span class="stat-value overdue">@dev.OverdueTasks</span>
                                    </div>
                                }
                            </div>

                            <div class="progress-section">
                                <div class="progress-header">
                                    <span>Completion Rate</span>
                                    <span class="progress-percentage">@dev.CompletionPercentage%</span>
                                </div>
                                <div class="progress-bar-container">
                                    <div class="progress-bar-bg">
                                        <div class="progress-bar-fill" style="width: @(dev.CompletionPercentage)%"></div>
                                    </div>
                                </div>
                                <div class="progress-breakdown">
                                    <div class="breakdown-segment done" style="width: @(dev.DonePercentage)%"
                                         title="Done: @dev.DoneTasks"></div>
                                    <div class="breakdown-segment in-review" style="width: @(dev.InReviewPercentage)%"
                                         title="In Review: @dev.InReviewTasks"></div>
                                    <div class="breakdown-segment in-progress" style="width: @(dev.InProgressPercentage)%"
                                         title="In Progress: @dev.InProgressTasks"></div>
                                    <div class="breakdown-segment backlog" style="width: @(dev.BacklogPercentage)%"
                                         title="Backlog: @dev.BacklogTasks"></div>
                                </div>
                            </div>

                            <div class="workload-chart">
                                <div class="chart-title">Task Distribution</div>
                                <div class="chart-bars">
                                    <div class="chart-bar">
                                        <div class="bar-fill backlog" style="height: @(PercentageCalculator.GetBarHeight(dev.BacklogTasks, dev.TotalTasks))%"></div>
                                        <div class="bar-label">Backlog</div>
                                        <div class="bar-value">@dev.BacklogTasks</div>
                                    </div>
                                    <div class="chart-bar">
                                        <div class="bar-fill in-progress" style="height: @(PercentageCalculator.GetBarHeight(dev.InProgressTasks, dev.TotalTasks))%"></div>
                                        <div class="bar-label">Progress</div>
                                        <div class="bar-value">@dev.InProgressTasks</div>
                                    </div>
                                    <div class="chart-bar">
                                        <div class="bar-fill in-review" style="height: @(PercentageCalculator.GetBarHeight(dev.InReviewTasks, dev.TotalTasks))%"></div>
                                        <div class="bar-label">Review</div>
                                        <div class="bar-value">@dev.InReviewTasks</div>
                                    </div>
                                    <div class="chart-bar">
                                        <div class="bar-fill done" style="height: @(PercentageCalculator.GetBarHeight(dev.DoneTasks, dev.TotalTasks))%"></div>
                                        <div class="bar-label">Done</div>
                                        <div class="bar-value">@dev.DoneTasks</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </section>

            <!-- Developer Timeline Section -->
            <section class="timeline-section">
                <div class="timeline-header">
                    <h2>Developer Timeline</h2>
                    <div class="timeline-date">@DateTime.Now.ToString("MMMM dd, yyyy")</div>
                </div>

                <div class="timeline-columns">
                    <!-- Backlog Column -->
                    <div class="timeline-column">
                        <div class="column-header">
                            <span class="status-badge ready">Backlog</span>
                            <span class="column-count">@TaskStatusHelper.GetItemsByStatus(projectItems, "Backlog")</span>
                        </div>
                        <ul class="task-list">
                            @foreach (var item in TaskStatusHelper.GetItemsForColumn(projectItems, "Backlog"))
                            {
                                <li class="task-item @DateHelper.GetOverdueClass(item)" @onclick="() => OpenItemUrl(item)">
                                    <div class="task-title">
                                        <span class="task-type-badge @item.GetItemTypeBadgeClass()">
                                            @item.GetItemTypeLabel()
                                        </span>
                                        @item.content?.title
                                    </div>
                                    <div class="task-meta">
                                        <div class="assignee-list">
                                            @if (item.GetAllAssignees().Any())
                                            {
                                                @foreach (var assignee in item.GetAllAssignees())
                                                {
                                                    <img src="@assignee.avatarUrl"
                                                         alt="@assignee.login"
                                                         title="@(assignee.name ?? assignee.login)"
                                                         class="assignee-avatar" />
                                                }
                                            }
                                            else
                                            {
                                                <span class="task-assignee">Unassigned</span>
                                            }
                                        </div>
                                        <div style="display: flex; gap: 8px; align-items: center;">
                                            @{
                                                var overdueInfo = DateHelper.GetOverdueInfo(item);
                                            }
                                            @if (overdueInfo.IsOverdue || overdueInfo.IsDueSoon)
                                            {
                                                <span class="overdue-badge @(overdueInfo.IsOverdue ? "overdue" : "due-soon")">
                                                    @overdueInfo.Message
                                                </span>
                                            }
                                            @if (item.content?.number != null)
                                            {
                                                <span>#@item.content.number</span>
                                            }
                                        </div>
                                    </div>
                                </li>
                            }
                        </ul>
                    </div>

                    <!-- In Progress Column -->
                    <div class="timeline-column">
                        <div class="column-header">
                            <span class="status-badge in-progress">In Progress</span>
                            <span class="column-count">@TaskStatusHelper.GetItemsByStatus(projectItems, "In progress")</span>
                        </div>
                        <ul class="task-list">
                            @foreach (var item in TaskStatusHelper.GetItemsForColumn(projectItems, "In progress"))
                            {
                                <li class="task-item @DateHelper.GetOverdueClass(item)" @onclick="() => OpenItemUrl(item)">
                                    <div class="task-title">
                                        <span class="task-type-badge @item.GetItemTypeBadgeClass()">
                                            @item.GetItemTypeLabel()
                                        </span>
                                        @item.content?.title
                                    </div>
                                    <div class="task-meta">
                                        <div class="assignee-list">
                                            @if (item.GetAllAssignees().Any())
                                            {
                                                @foreach (var assignee in item.GetAllAssignees())
                                                {
                                                    <img src="@assignee.avatarUrl"
                                                         alt="@assignee.login"
                                                         title="@(assignee.name ?? assignee.login)"
                                                         class="assignee-avatar" />
                                                }
                                            }
                                            else
                                            {
                                                <span class="task-assignee">Unassigned</span>
                                            }
                                        </div>
                                        <div style="display: flex; gap: 8px; align-items: center;">
                                            @{
                                                var overdueInfo = DateHelper.GetOverdueInfo(item);
                                            }
                                            @if (overdueInfo.IsOverdue || overdueInfo.IsDueSoon)
                                            {
                                                <span class="overdue-badge @(overdueInfo.IsOverdue ? "overdue" : "due-soon")">
                                                    @overdueInfo.Message
                                                </span>
                                            }
                                            @if (item.content?.number != null)
                                            {
                                                <span>#@item.content.number</span>
                                            }
                                        </div>
                                    </div>
                                </li>
                            }
                        </ul>
                    </div>

                    <!-- In Review Column -->
                    <div class="timeline-column">
                        <div class="column-header">
                            <span class="status-badge unassigned">In Review</span>
                            <span class="column-count">@TaskStatusHelper.GetItemsByStatus(projectItems, "In review")</span>
                        </div>
                        <ul class="task-list">
                            @foreach (var item in TaskStatusHelper.GetItemsForColumn(projectItems, "In review"))
                            {
                                <li class="task-item @DateHelper.GetOverdueClass(item)" @onclick="() => OpenItemUrl(item)">
                                    <div class="task-title">
                                        <span class="task-type-badge @item.GetItemTypeBadgeClass()">
                                            @item.GetItemTypeLabel()
                                        </span>
                                        @item.content?.title
                                    </div>
                                    <div class="task-meta">
                                        <div class="assignee-list">
                                            @if (item.GetAllAssignees().Any())
                                            {
                                                @foreach (var assignee in item.GetAllAssignees())
                                                {
                                                    <img src="@assignee.avatarUrl"
                                                         alt="@assignee.login"
                                                         title="@(assignee.name ?? assignee.login)"
                                                         class="assignee-avatar" />
                                                }
                                            }
                                            else
                                            {
                                                <span class="task-assignee">Unassigned</span>
                                            }
                                        </div>
                                        <div style="display: flex; gap: 8px; align-items: center;">
                                            @{
                                                var overdueInfo = DateHelper.GetOverdueInfo(item);
                                            }
                                            @if (overdueInfo.IsOverdue || overdueInfo.IsDueSoon)
                                            {
                                                <span class="overdue-badge @(overdueInfo.IsOverdue ? "overdue" : "due-soon")">
                                                    @overdueInfo.Message
                                                </span>
                                            }
                                            @if (item.content?.number != null)
                                            {
                                                <span>#@item.content.number</span>
                                            }
                                        </div>
                                    </div>
                                </li>
                            }
                        </ul>
                    </div>

                    <!-- Done Column -->
                    <div class="timeline-column">
                        <div class="column-header">
                            <span class="status-badge ready">Done</span>
                            <span class="column-count">@TaskStatusHelper.GetItemsByStatus(projectItems, "Done")</span>
                        </div>
                        <ul class="task-list">
                            @foreach (var item in TaskStatusHelper.GetItemsForColumn(projectItems, "Done").Take(5))
                            {
                                <li class="task-item" @onclick="() => OpenItemUrl(item)">
                                    <div class="task-title">
                                        <span class="task-type-badge @item.GetItemTypeBadgeClass()">
                                            @item.GetItemTypeLabel()
                                        </span>
                                        @item.content?.title
                                    </div>
                                    <div class="task-meta">
                                        <div class="assignee-list">
                                            @if (item.GetAllAssignees().Any())
                                            {
                                                @foreach (var assignee in item.GetAllAssignees())
                                                {
                                                    <img src="@assignee.avatarUrl"
                                                         alt="@assignee.login"
                                                         title="@(assignee.name ?? assignee.login)"
                                                         class="assignee-avatar" />
                                                }
                                            }
                                            else
                                            {
                                                <span class="task-assignee">Unassigned</span>
                                            }
                                        </div>
                                        @if (item.content?.number != null)
                                        {
                                            <span>#@item.content.number</span>
                                        }
                                    </div>
                                </li>
                            }
                        </ul>
                    </div>
                </div>
            </section>
        }
        else
        {
            <div class="empty-state">
                <p>No ProjectV2 data found for @selectedOrg.</p>
            </div>
        }
    }
</div>

@code {
    private bool loading = true;
    private string? error;

    // ProjectV2
    private GitHubProjectV2ResponseDto? projectResponse;
    private ProjectV2? project;
    private List<ProjectItem> projectItems = new();
    private int projectNumber = 11;

    private List<string> organizations = new();
    private string? selectedOrg = "VariosystemsWorkspace";

    // Computed data
    private TaskAnalytics analytics = new();
    private List<DeveloperWorkload> workloads = new();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            organizations = await GitHubService.GetOrganizationsAsync();

            if (string.IsNullOrEmpty(selectedOrg) && organizations.Any())
            {
                selectedOrg = organizations.FirstOrDefault();
            }

            if (!string.IsNullOrEmpty(selectedOrg))
            {
                projectResponse = await GitHubService.GetProjectV2Async(selectedOrg, projectNumber, 100);
                project = projectResponse?.data?.organization?.projectV2;

                if (project?.items?.nodes != null)
                {
                    projectItems = project.items.nodes;
                }

                // Calculate analytics using services
                analytics = AnalyticsService.GetAnalytics(project);
                workloads = WorkloadService.GetDeveloperWorkloads(project);
            }
        }
        catch (Exception ex)
        {
            error = $"Error loading data: {ex.Message}";
            Console.WriteLine($"Error details: {ex}");
        }
        finally
        {
            loading = false;
        }
    }

    private void OpenItemUrl(ProjectItem item)
    {
        if (!string.IsNullOrEmpty(item.content?.url))
        {
            NavigationManager.NavigateTo(item.content.url, true);
        }
    }
}